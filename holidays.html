<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Danske Helligdage</title>
<script type="text/javascript" src="page.js"></script>
<style type="text/css">
div.linebreak {
    width: 100%;
}

div.box#control {
    text-align: center;
    width: 100%;
}

input {
    margin: 2px 0px 2px 0px;
    text-align: center;
    vertical-align: middle;
}

h2 {
    text-align: center;
}

table.plain {
    margin: auto;
    border-collapse: separate;
    border-spacing: 0em 0.2em;
}

table.plain td {
    text-align: left;
    background-color: #DDF8FF;
    padding: 0em 0.2em;
}
</style>
<script type="text/javascript">
"use strict";

genericPageSetup.extra_menu_buttons = [
    ['lang_button', 'English', 'change_language()'],
];

// Hack to get around javascript's weird % behavior (x%y takes the sign of x rather than y)
function mod(x, y)
{
    return (x % y + y) % y;
}

const MONDAY = 0;
const TUESDAY = 1;
const WEDNESDAY = 2;
const THURSDAY = 3;
const FRIDAY = 4;
const SATURDAY = 5;
const SUNDAY = 6;

class Year
{
    year;
    is_leapyear;
    days_in_month = [undefined,31,28,31,30,31,30,31,31,30,31,30,31]; // Indexed with 1-based month
    month_daynums = new Array(14);  // Days from 0001-01-01 to first day of each month of this year
                                    // (indexed with 1-based month, index 13 is January of next year)
    week1_date;                     // Date of first day of week 1 of this year
    easter_date;                    // Date of Easter Day of this year

    static Date = class
    {
        year_obj;   // Year object for this date's year
        month;      // 1-12
        day;        // 1-31
        daynum;     // Days from 0001-01-01 to this date
        weekday;    // 0=Monday..6=Sunday

        // Date constructor arguments can be either (year_obj, month, day) or (year_obj, daynum)
        constructor(year_obj, month_or_daynum, day=null)
        {
            this.year_obj = year_obj;
            if (day === null) {
                // month_or_daynum is actually daynum
                this.daynum = month_or_daynum;
                // Find month by searching month_daynums
                let month;
                for (month = 1; month <= 12; month++) {
                    if (this.daynum < year_obj.month_daynums[month + 1]) break;
                }
                this.month = month;
                this.day = this.daynum - year_obj.month_daynums[month] + 1;
            } else {
                // month_or_daynum is actually month
                this.month = month_or_daynum;
                this.day = day;
                this.daynum = year_obj.month_daynums[this.month] + day - 1;
            }
            this.weekday = mod(this.daynum, 7);
        }

        // Returns a new Date that is n days after this date
        add_days(n)
        {
            return new Year.Date(this.year_obj, this.daynum + n);
        }

        // Returns the date of the first occurrence of the given weekday on or after this date
        first(weekday)
        {
            const days_until_weekday = mod(weekday - this.weekday, 7);
            return this.add_days(days_until_weekday);
        }

        // Returns the date of the last occurrence of the given weekday on or before this date
        last(weekday)
        {
            const days_since_weekday = mod(this.weekday - weekday, 7);
            return this.add_days(-days_since_weekday);
        }
    }

    constructor(year)
    {
        // If invalid year given, use current year
        if (isNaN(year) || year < 0) year = (new Date()).getFullYear();

        this.year = year;
        this.is_leapyear = mod(year, 4) == 0 && (mod(year, 100) != 0 || mod(year, 400) == 0);
        if (this.is_leapyear) this.days_in_month[2] = 29;

        // Calculate daynum of (i.e. days from Jan 1 of year 0001 to) Jan 1 of this year
        const prev_year = year - 1;
        const jan_1_daynum = prev_year * 365
            + Math.floor(prev_year / 4)
            - Math.floor(prev_year / 100)
            + Math.floor(prev_year / 400);

        // Calculate daynums for the first day of each month of this year (and for Jan 1 of next year)
        this.month_daynums[1] = jan_1_daynum;
        for (let m = 2; m <= 13; m++) {
            this.month_daynums[m] = this.month_daynums[m - 1] + this.days_in_month[m - 1];
        }

        // Find date of first day of week 1 (Monday on or before Jan 4th)
        this.week1_date = new Year.Date(this, 1, 4).last(MONDAY);

        // Calculate Easter date of this year
        const a = mod(year, 19);
        const b = Math.floor(year / 100);
        const c = Math.floor(b / 4);
        let i = mod(b - c - Math.floor((b - Math.floor((b - 17) / 25)) / 3) + 19 * a + 15, 30);
        const e = Math.floor(i / 28);
        i = i - e * (1 - e * Math.floor(29 / (i + 1)) * Math.floor((21 - a) / 11));
        i = i - mod(year + Math.floor(year / 4) + i + 2 - b + c, 7);
        const m = 3 + Math.floor((i + 40) / 44);
        this.easter_date = new Year.Date(this, m, i + 28 - 31 * Math.floor(m / 4));
    }

    date(month, day)
    {
        return new Year.Date(this, month, day);
    }

    date_from_daynum(daynum)
    {
        return new Year.Date(this, daynum);
    }
}

class SpecialDay
{
    name;
    date;

    constructor(name, date)
    {
        this.name = name;
        this.date = date;
    }
}

class Language
{
    constructor(lang_id)
    {
        const idx = lang_id == 'da' ? 0 : 1;
        this.lang_id = ['da','en'][idx];
        this.title = ['Danske Helligdage &Aring;r ', 'Danish Holidays Year '][idx];
        this.year_input_label = ['V&aelig;lg nyt &aring;rstal:', 'Select new year:'][idx];
        this.months = [
            ["jan","feb","mar","apr","maj","jun","jul","aug","sep","okt","nov","dec"],
            ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]
        ][idx];
        this.weekdays = [
            ["mandag","tirsdag","onsdag","torsdag","fredag","l&oslash;rdag","s&oslash;ndag"],
            ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"]
        ][idx];

        this.floating_holiday_title = ['Flydende helligdage', 'Floating holidays'][idx];
        this.quinquagesima_sunday_txt = ['Fastelavn', 'Quinquagesima Sunday'][idx];
        this.palm_sunday = ['Palmes&oslash;ndag', 'Palm Sunday'][idx];
        this.maundy_thursday = ['Sk&aelig;rtorsdag', 'Maundy Thursday'][idx];
        this.good_friday = ['Langfredag', 'Good Friday'][idx];
        this.easter_day = ['P&aring;skedag', 'Easter Day'][idx];
        this.easter_monday = ['2. p&aring;skedag', 'Easter Monday'][idx];
        this.prayer_day = ['Store bededag', 'Prayer Day'][idx];
        this.ascension_day = ['Kristi himmelfartsdag', 'Ascension Day'][idx];
        this.whitsunday = ['Pinsedag', 'Whitsunday'][idx];
        this.whitmonday = ['2. pinsedag', 'Whitmonday'][idx];

        this.other_special_day_title = ['Andre m&aelig;rkedage', 'Other special days'][idx];
        this.new_years_day = ['Nyt&aring;rsdag', 'New Year\'s Day'][idx];
        this.valentines_day = ['Valentinsdag', 'Valentine\'s Day'][idx];
        this.daylight_saving_begins = ['Sommertid begynder', 'Daylight Saving begins'][idx];
        this.mothers_day = ['Mors dag', 'Mother\'s Day'][idx];
        this.constitution_day = ['Grundlovsdag', 'Constitution Day'][idx];
        this.fathers_day = ['Fars dag', 'Father\'s Day'][idx];
        this.autumn_holiday_week_begins = ['Efter&aring;rsferien begynder', 'Autumn holiday week begins'][idx];
        this.daylight_saving_ends = ['Sommertid ender', 'Daylight Saving ends'][idx];
        this.halloween = ['Halloween', 'Halloween'][idx];
        this.all_saints_sunday = ['Allehelgenss&oslash;ndag', 'All Saints\' Sunday'][idx];
        this.black_friday = ['Black Friday', 'Black Friday'][idx];
        this.first_sunday_in_advent = ['1. s&oslash;ndag i advent', '1st Sunday in Advent'][idx];
        this.christmas_day = ['Juledag', 'Christmas Day'][idx];
        this.boxing_day = ['2. juledag', 'Boxing Day'][idx];
        this.new_years_eve = ['Nyt&aring;rsaften', 'New Year\'s Eve'][idx];
    }

    date_str(date)
    {
        return this.weekdays[date.weekday] + ', ' +
            (this.lang_id == 'da' ?
                date.day + '. ' + this.months[date.month - 1] :
                this.months[date.month - 1] + ' ' + date.day);
    }
}

let lang;
let year_obj;

function show()
{
    let hs;
    const y = year_obj;

    document.documentElement.lang = lang.lang_id;
    document.getElementById('title').innerHTML = lang.title + y.year;
    document.getElementById('year_input_label').innerHTML = lang.year_input_label;
    document.getElementById('year_input').value = y.year;
    document.getElementById('lang_button').innerHTML = lang.lang_id == 'da' ? 'English' : 'Dansk';

    // Floating holidays

    let special_days = [];

    special_days.push(new SpecialDay(lang.quinquagesima_sunday_txt,
        y.easter_date.add_days(-49)));

    special_days.push(new SpecialDay(lang.palm_sunday,
        y.easter_date.add_days(-7)));

    special_days.push(new SpecialDay(lang.maundy_thursday,
        y.easter_date.add_days(-3)));

    special_days.push(new SpecialDay(lang.good_friday,
        y.easter_date.add_days(-2)));

    special_days.push(new SpecialDay(lang.easter_day,
        y.easter_date));

    special_days.push(new SpecialDay(lang.easter_monday,
        y.easter_date.add_days(1)));

    if (y.year < 2024) {
        special_days.push(new SpecialDay(lang.prayer_day,
            y.easter_date.add_days(26)));
    }

    special_days.push(new SpecialDay(lang.ascension_day,
        y.easter_date.add_days(39)));

    special_days.push(new SpecialDay(lang.whitsunday,
        y.easter_date.add_days(49)));

    special_days.push(new SpecialDay(lang.whitmonday,
        y.easter_date.add_days(50)));

    special_days.sort((d1, d2) => d1.date.daynum - d2.date.daynum);

    hs = "<h2>" + lang.floating_holiday_title + "<\/h2>"
        + "<table class='plain'>"
        + special_days.map(d => "<tr><td>" + d.name + ":<td>" + lang.date_str(d.date)).join('')
        + "<\/table>";
    document.getElementById('floating_days').innerHTML = hs;

    // Other special days

    special_days = [];

    special_days.push(new SpecialDay(lang.new_years_day,
        y.date(1, 1)));

    special_days.push(new SpecialDay(lang.valentines_day,
        y.date(2, 14)));

    special_days.push(new SpecialDay(lang.daylight_saving_begins,
        y.date(3, 31).last(SUNDAY))); // Last Sunday in March

    special_days.push(new SpecialDay(lang.mothers_day,
        y.date(5, 1 + 7).first(SUNDAY))); // Second Sunday in May

    special_days.push(new SpecialDay(lang.constitution_day,
        y.date(6, 5)));

    special_days.push(new SpecialDay(lang.fathers_day,
        y.date(6, 5)));

    special_days.push(new SpecialDay(lang.autumn_holiday_week_begins,
        y.week1_date.add_days(41 * 7))); // First day of week 42

    special_days.push(new SpecialDay(lang.daylight_saving_ends,
        y.date(10, 31).last(SUNDAY))); // Last Sunday in October

    special_days.push(new SpecialDay(lang.halloween,
        y.date(10, 31)));

    special_days.push(new SpecialDay(lang.all_saints_sunday,
        y.date(11, 1).first(SUNDAY))); // First Sunday in November

    // Black Friday is the day after American Thanksgiving which is the 4th Thursday in November
    special_days.push(new SpecialDay(lang.black_friday,
        y.date(11, 1).first(THURSDAY)   // First Thursday in November
            .add_days(3 * 7 + 1)));     // Friday after 4th Thursday in November

    special_days.push(new SpecialDay(lang.first_sunday_in_advent,
        y.date(12, 24 - 3 * 7).last(SUNDAY))); // Sunday on or before the day that is 3 weeks before Dec 24th

    special_days.push(new SpecialDay(lang.christmas_day,
        y.date(12, 25)));

    special_days.push(new SpecialDay(lang.boxing_day,
        y.date(12, 26)));

    special_days.push(new SpecialDay(lang.new_years_eve,
        y.date(12, 31)));

    if (y.year >= 2024) {
        special_days.push(new SpecialDay(lang.prayer_day,
            y.easter_date.add_days(26)));
    }

    special_days.sort((d1, d2) => d1.date.daynum - d2.date.daynum);

    hs = "<h2>" + lang.other_special_day_title + "<\/h2>"
        + "<table class='plain'>"
        + special_days.map(d => "<tr><td>" + d.name + ":<td>" + lang.date_str(d.date)).join('')
        + "<\/table>";
    document.getElementById('other_days').innerHTML = hs;
}

function change_year()
{
    const year = 1 * document.getElementById('year_input').value;
    year_obj = new Year(year);
    show();
}

function change_year_if_enter(e)
 {
    if (window.event)
        e = window.event;
    if (e.key == 'Enter')
    {
        change_year();
        return false;
    }
    else
    {
        return true;
    }
}

function change_language()
{
    lang = new Language(lang.lang_id == 'da' ? 'en' : 'da');
    show();
}

function init()
{
    lang = new Language('da');
    year_obj = new Year(); // Current year

    // Handle URL arguments
    const page_settings_spec = {
        year: {
            get: function() {return year_obj.year},
            set: function(v) {year_obj = new Year(v)}
        },
        lang: {
            get: function() {return lang.lang_id},
            set: function(v) {lang = new Language(v)}
        },
    };
    genericPageSetup.apply_settings_from_url(page_settings_spec);

    show();

    document.getElementById('year_input').onkeydown = change_year_if_enter;
}

window.addEventListener('load', init, false);
</script>
</head>

<body>

<div class="hcontainer">

<h1 id="title"></h1>

<div class="box" id="control">
<label id="year_input_label" for="year_input"></label>
<input id="year_input" type="text" size="4" maxlength="4" onchange="change_year();">
</div>

<div class="box" id="floating_days">
</div>

<div class="box" id="other_days">
</div>

</div>

</body>
</html>
